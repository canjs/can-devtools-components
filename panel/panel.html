<!doctype html>
<html>
    <head>
        <style>
		html, body {
			height: 100%;
		}
        </style>
    </head>

    <body>
        <todo-list></todo-list>
        <br><br><hr><br><br>
        <components-panel></components-panel>

        <script src="../node_modules/steal/steal.js">
            import { Component, Reflect } from "can-devtools-components/panel/panel";
            // demo app code
            Component.extend({
                tag: "todo-item",
                view: `
                    <input type="checkbox" checked:from="this.complete" disabled>
                    <span>{{ this.name }}</span>
                `,
                ViewModel: {
                    name: "string",
                    complete: "boolean"
                }
            });

            Component.extend({
                tag: "todo-editor",
                view: `
                    <input type="checkbox" checked:bind="this.complete">
                    <input type="text" value:bind="this.name">
                `,
                ViewModel: {
                    name: "string",
                    complete: "boolean"
                }
            });

            Component.extend({
                tag: "todo-list",
                view: `
                    {{# for(todo of this.todos) }}
                      <div on:click="this.editing = todo">
                      {{# if( this.isEditing(todo) ) }}
                        <todo-editor name:bind="todo.name" complete:bind="todo.complete" />
                      {{ else }}
                        <todo-item name:bind="todo.name" complete:bind="todo.complete" />
                      {{/ if }}
                      </div>
                    {{/ for }}
                `,
                ViewModel: {
                    editing: {
                        type: "any",
                        default() {
                            return this.todos[1];
                        }
                    },
                    isEditing(todo) {
                        return todo === this.editing;
                    },
                    todos: {
                        default() {
                            return [{
                                name: "create a list",
                                complete: true
                            }, {
                                name: "go shopping",
                                complete: false
                            }, {
                                name: "make dinner",
                                complete: false
                            }];
                        }
                    }
                }
            });


            // panel code
            const vm = document.querySelector("components-panel").viewModel;

            vm.componentTree.updateDeep([{
                tagName: "todo-list",
                id: 0,
                children: [{
                    tagName: "todo-item",
                    id: 1,
                    children: []
                },{
                    tagName: "todo-editor",
                    id: 2,
                    children: []
                },{
                    tagName: "todo-item",
                    id: 3,
                    children: []
                }]
            }]);

            const elsById = {
                0: document.querySelector("todo-list"),
                1: document.querySelectorAll("todo-item")[0],
                2: document.querySelector("todo-editor"),
                3: document.querySelectorAll("todo-item")[1],
            };

            let sourceVm;

            vm.updateValues = (data) => {
                if(sourceVm) {
                    Reflect.updateDeep(sourceVm, data);
                    Reflect.updateDeep(vm.viewModelData, sourceVm.serialize());
                }
            };

            vm.listenTo("selectedNode", (ev, node) => {
                const el = elsById[node.id];
                sourceVm = el.viewModel;
                Reflect.updateDeep(vm.viewModelData, sourceVm.serialize());
            });
        </script>
    </body>
    <html>

<!doctype html>
<html>
	<head>
		<style>
		html, body {
			height: 100%;
		}
		</style>
	</head>

	<body>
		<todo-list></todo-list>
		<br><br><hr><br><br>
		<components-panel></components-panel>

		<script src="../node_modules/steal/steal.js">
			import { Component, Reflect } from "can-devtools-components/panel/panel";
			// demo app code
			Component.extend({
				tag: "todo-item",
				view: `
					<input type="checkbox" checked:from="this.complete" disabled>
					<span>{{ this.name }}</span>
				`,
				ViewModel: {
					name: "string",
					complete: "boolean"
				}
			});

			Component.extend({
				tag: "todo-editor",
				view: `
					<input type="checkbox" checked:bind="this.complete">
					<input type="text" value:bind="this.name">
				`,
				ViewModel: {
					name: "string",
					complete: "boolean"
				}
			});

			Component.extend({
				tag: "todo-list",
				view: `
					{{# for(todo of this.todos) }}
					  <div on:click="this.editing = todo">
					  {{# if( this.isEditing(todo) ) }}
						<todo-editor name:bind="todo.name" complete:bind="todo.complete" />
					  {{ else }}
						<todo-item name:bind="todo.name" complete:bind="todo.complete" />
					  {{/ if }}
					  </div>
					{{/ for }}
				`,
				ViewModel: {
					editing: {
						type: "any",
						default() {
							return this.todos[1];
						}
					},
					isEditing(todo) {
						return todo === this.editing;
					},
					todos: {
						default() {
							return [{
								name: "create a list",
								complete: true
							}, {
								name: "go shopping",
								complete: false
							}, {
								name: "make dinner",
								complete: false
							}, {
								name: "create a list, again",
								complete: true
							}, {
								name: "go shopping, again",
								complete: false
							}, {
								name: "make dinner, again",
								complete: false
							}, {
								name: "create a list, one more time",
								complete: true
							}, {
								name: "go shopping, one more time",
								complete: false
							}, {
								name: "make dinner, one more time",
								complete: false
							}];
						}
					}
				}
			});


			// panel code
			const vm = document.querySelector("components-panel").viewModel;

			vm.componentTree.updateDeep([{
				selected: false,
				tagName: "todo-list",
				id: 0,
				children: [{
					selected: false,
					tagName: "todo-item",
					id: 1,
					children: []
				},{
					selected: true,
					tagName: "todo-editor",
					id: 2,
					children: []
				},{
					selected: false,
					tagName: "todo-item",
					id: 3,
					children: []
				}]
			}]);

			const elsById = {
				0: document.querySelector("todo-list"),
				1: document.querySelectorAll("todo-item")[0],
				2: document.querySelector("todo-editor"),
				3: document.querySelectorAll("todo-item")[1],
			};

			let sourceVm;

			vm.updateValues = (data) => {
				if(sourceVm) {
					Reflect.updateDeep(sourceVm, data);
					Reflect.updateDeep(vm.viewModelData, sourceVm.serialize());
				}
			};

			let selectedNode = null;
			vm.listenTo("selectedNode", (ev, node) => {
				vm.breakpointsError = null;
				selectedNode = node;
				const el = elsById[node.id];
				sourceVm = el.viewModel;
				Reflect.updateDeep(vm.viewModelData, sourceVm.serialize());
			});

			const breakpoints = [];
			let nextBreakpointId = 0;

			const getIndexOfBreakpoint = (id) => {
				let index = -1;

				breakpoints.some((bp, i) => {
					if (bp.id === id) {
						index = i;
						return true;
					}
				});

				return index;
			};

			vm.addBreakpoint = (expression) => {
				if(!selectedNode) {
					vm.breakpointsError = "Select a component in order to create a mutation breakpoint for its ViewModel";
					return;
				}
				breakpoints.push({
					id: nextBreakpointId++,
					expression: expression,
					enabled: true
				});
				vm.breakpoints = breakpoints;
			};

			vm.toggleBreakpoint = (bp) => {
				const index = getIndexOfBreakpoint(bp.id);
				breakpoints[index].enabled = !breakpoints[index].enabled;
				vm.breakpoints = breakpoints;
			};

			vm.deleteBreakpoint = (bp) => {
				const index = getIndexOfBreakpoint(bp.id);
				breakpoints.splice(index, 1);
				vm.breakpoints = breakpoints;
			};
		</script>
	</body>
	<html>
